<% content_for :title, "User accounts" %>

<div class="page-title">
  <h1>User accounts</h1>
</div>

<div class="well remove-bottom-margin">
  <div class="row">
    <div class="col-md-7">
      <%= form_tag nil, method: "get", class: 'form-inline' do %>
        <%= label_tag 'filter', 'Filter by name or email', class: 'add-right-margin' %><br />
        <%= text_field_tag "filter", params[:filter], class: 'form-control input-md-5' %>
        <%= submit_tag "Search", class: "add-left-margin btn btn-default" %>
      <% end %>
    </div>
    <div class="col-md-5 text-right">
      <%= link_to "Create user", new_user_invitation_path, class: "btn btn-success add-right-margin" %>
      <% if can? :create, BatchInvitation %>
        <%= link_to "Upload a batch of users", new_admin_batch_invitation_path, class: "btn btn-default" %>
      <% end %>
    </div>
  </div>
</div>

  <div class="row-fluid">
    <ul>
      <% User.roles.each do |role_name| %>
        <li>
          <%= link_to role_name.humanize, current_path_with_role_filter(role_name) %>
        </li>
      <% end %>
      <li>
        <%= link_to "All roles", current_path_with_role_filter(nil) %>
      </li>
    </ul>
  </div>

  <%= render partial: "pagination" %>

  <table class="table table-striped table-bordered">
    <thead>
      <tr class="table-header">
        <th scope="col">Name and email</th>
        <th scope="col">Role</th>
        <th scope="col">Sign-in count</th>
        <th scope="col">Last sign-in</th>
        <th scope="col">Created</th>
        <th scope="col">Suspended?</th>
        <th scope="col">Actions</th>
      </tr>
    </thead>
    <tbody>
      <% @users.each do |user| %>
        <tr>
          <td class="email">
            <%= user.suspended? ? "<del>".html_safe : "" %>
              <%= link_to "#{user.name} <#{user.email}>", edit_admin_user_path(user) %>
            <%= user.suspended? ? "</del>".html_safe : "" %>
          </td>
          <td class="role"><%= user.role.humanize %></td>
          <td><%= user.sign_in_count %></td>
          <td class="last-sign-in">
            <% if user.current_sign_in_at %>
              <%= time_ago_in_words(user.current_sign_in_at) %> ago
            <% else %>
              never signed in
            <% end %>
          </td>
          <td><%= time_ago_in_words(user.created_at) %> ago</td>
          <td><%= user.suspended? ? "Yes" : "No" %></td>
          <td>
            <% if user.invited_but_not_accepted %>
              <%= form_tag resend_user_invitation_path(user) do %>
                <%= submit_tag "Resend signup email", :class => 'btn btn-sm btn-default' %>
              <% end %>
            <% end %>
            <% if user.access_locked? %>
              <%= form_tag unlock_admin_user_path(user) do %>
                <%= submit_tag "Unlock account", :class => 'btn btn-default' %>
              <% end %>
            <% end %>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>

  <%= render partial: "pagination" %>
