<h1>Create a batch of users</h1>

<div class="well">
  <%= form_for([:admin, @batch_invitation]) do |f| %>
    <h2>Upload a CSV</h2>
    <div class="row">
      <div class="span5">
        <%= f.label :user_names_and_emails, "Choose a CSV file of users with names and email addresses" %>
        <%= f.file_field(:user_names_and_emails, :accept => 'text/csv') %>
      </div>
      <div class="span5 pull-right">
        <p>The format of the CSV should be as follows:</p>
        <pre>
Name,Email
Jane Smith,john@mail.com
Winston Churchill,winston@mail.com
        </pre>
      </div>
    </div>

    <h2>Permissions for the users</h2>

    <table class="table table-bordered table-striped table-condensed">
      <thead>
        <tr>
          <th class="span1">Application</th>
          <th class="span1">Has access?</th>
          <th class="span1">Other Permissions</th>
        </tr>
      </thead>
      <tbody>
        <% applications_and_permissions(User.new).each_with_index do |(application, permission), index| %>
          <tr>
            <td>
              <%= application.name %>
              <%= hidden_field_tag "user[permissions_attributes][#{index}][application_id]", application.id %>
              <%= hidden_field_tag "user[permissions_attributes][#{index}][id]", permission.id %>
            </td>
            <td>
              <!-- Emulate form.check_box helper http://api.rubyonrails.org/v3.1.3/classes/ActionView/Helpers/FormHelper.html#method-i-check_box -->
              <%= hidden_field_tag "user[permissions_attributes][#{index}][signin_permission]", "0" %>
              <%= label_tag "user[permissions_attributes][#{index}][signin_permission]", "Has access to #{application.name}?", class: "visuallyhidden" %>
              <%= check_box_tag "user[permissions_attributes][#{index}][signin_permission]", "1", permission.permissions.include?("signin") %>
            </td>
            <td>
              <%= label_tag "user[permissions_attributes][#{index}][permissions][]", "Permissions for #{application.name}", class: "visuallyhidden" %>
              <%= select_tag "user[permissions_attributes][#{index}][permissions][]", options_for_select(application.supported_permission_strings - ["signin"], permission.permissions - ["signin"]), multiple: true, class: "chzn-select", "data-placeholder" => "Start typing to search for permissions" %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
    <%= f.submit "Create users and send emails", :class => 'btn btn-success' %>
  <% end %>
</div>

<script type="text/javascript">
  $(".chzn-select").chosen();
</script>
